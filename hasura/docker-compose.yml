version: '3.8'

services:
  hasura:
    image: hasura/graphql-engine:latest
    ports:
      - "8090:8080"
    environment:
      ## PostgreSQL connection from existing database
      HASURA_GRAPHQL_DATABASE_URL: postgresql://wms_user:wms_secure_password_2024@host.docker.internal:5439/kiaan_wms

      ## Enable console
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true"

      ## Admin secret for authentication
      HASURA_GRAPHQL_ADMIN_SECRET: "kiaan_hasura_admin_secret_2024"

      ## Enable dev mode (useful for development)
      HASURA_GRAPHQL_DEV_MODE: "true"

      ## Enable enhanced hasura logs for debugging
      HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log

      ## JWT Secret (for authentication)
      # HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256", "key":"kiaan_wms_jwt_secret_key_super_secure_2024"}'

      ## Enable unauthorized role for public access (optional)
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: "anonymous"

      ## CORS settings
      HASURA_GRAPHQL_CORS_DOMAIN: "*"

      ## Enable remote schema permissions
      HASURA_GRAPHQL_ENABLE_REMOTE_SCHEMA_PERMISSIONS: "true"

      ## Metadata database (using same as main DB)
      HASURA_GRAPHQL_METADATA_DATABASE_URL: postgresql://wms_user:wms_secure_password_2024@host.docker.internal:5439/kiaan_wms

    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: ["CMD", "wget", "-O", "-", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Metabase - Analytics & BI Tool (ZERO CODING!)
  metabase:
    image: metabase/metabase:latest
    ports:
      - "3002:3000"
    environment:
      MB_DB_TYPE: h2
      MB_DB_FILE: /metabase-data/metabase.db
    volumes:
      - metabase_data:/metabase-data
    restart: unless-stopped

  # Redis - Caching & Real-time
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  hasura_metadata:
  metabase_data:
  redis_data:
