// Kiaan WMS - Comprehensive Database Schema
// Food Distribution Warehouse Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// CORE ENTITIES
// ===================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(USER)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  // Picking assignments
  pickLists PickList[]

  // Stock adjustments
  adjustmentsRequested StockAdjustment[]
  adjustmentsApproved  StockAdjustment[] @relation("ApprovedAdjustments")

  // Inventory movements
  inventoryMovements InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([email])
}

enum Role {
  SUPER_ADMIN
  COMPANY_ADMIN
  WAREHOUSE_MANAGER
  INVENTORY_MANAGER
  PICKER
  VIEWER
  ADMIN
  USER
  PACKER
  MANAGER
}

model Company {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  address     String?
  phone       String?
  email       String?

  users       User[]
  warehouses  Warehouse[]
  products    Product[]
  customers   Customer[]
  suppliers   Supplier[]
  brands      Brand[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
}

// ===================================
// WAREHOUSE STRUCTURE
// ===================================

model Warehouse {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  type        WarehouseType @default(MAIN)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  address     String?
  phone       String?
  capacity    Int?
  status      WarehouseStatus @default(ACTIVE)

  zones       Zone[]
  locations   Location[]
  inventory   Inventory[]
  transfersFrom Transfer[] @relation("TransferFrom")
  transfersTo   Transfer[] @relation("TransferTo")
  adjustments StockAdjustment[]
  cycleCounts CycleCount[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
  @@index([type])
}

enum WarehouseType {
  MAIN        // Main warehouse
  PREP        // FBA preparation warehouse
  RETURNS     // Returns processing
  OVERFLOW    // Overflow storage
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

model Zone {
  id          String   @id @default(uuid())
  name        String
  code        String
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  zoneType    ZoneType @default(STANDARD)

  locations   Location[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([warehouseId, code])
  @@index([warehouseId])
}

enum ZoneType {
  STANDARD
  COLD
  FROZEN
  HAZMAT
  QUARANTINE
}

model Location {
  id          String   @id @default(uuid())
  name        String
  code        String
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  zoneId      String?
  zone        Zone?    @relation(fields: [zoneId], references: [id])
  aisle       String?
  rack        String?
  shelf       String?
  bin         String?

  inventory   Inventory[]
  pickItems   PickItem[]
  adjustmentItems StockAdjustmentItem[]

  // Inventory movements
  movementsFrom InventoryMovement[] @relation("MovementsFrom")
  movementsTo   InventoryMovement[] @relation("MovementsTo")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@index([zoneId])
}

// ===================================
// PRODUCT MANAGEMENT (Food Focus)
// ===================================

model Brand {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  products    Product[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
}

model Product {
  id              String      @id @default(uuid())
  sku             String      @unique
  name            String
  description     String?
  barcode         String?
  companyId       String
  company         Company     @relation(fields: [companyId], references: [id])
  brandId         String?
  brand           Brand?      @relation(fields: [brandId], references: [id])
  type            ProductType @default(SIMPLE)
  status          ProductStatus @default(ACTIVE)

  // Physical dimensions
  length          Float?
  width           Float?
  height          Float?
  weight          Float?
  dimensionUnit   String?     @default("cm")
  weightUnit      String?     @default("kg")

  // Pricing
  costPrice       Float?
  sellingPrice    Float?
  currency        String      @default("GBP")

  // Food-specific
  isPerishable    Boolean     @default(false)
  requiresBatch   Boolean     @default(false)
  requiresSerial  Boolean     @default(false)
  shelfLifeDays   Int?        // Expected shelf life in days

  // Bundle support
  bundleItems     BundleItem[] @relation("ParentBundle")
  partOfBundles   BundleItem[] @relation("ChildProduct")

  // Inventory
  inventory       Inventory[]
  orderItems      SalesOrderItem[]
  pickItems       PickItem[]

  // Replenishment
  replenConfig    ReplenishmentConfig?
  replenTasks     ReplenishmentTask[]

  // Channel pricing
  channelPrices   ChannelPrice[]

  // Stock adjustments
  adjustmentItems StockAdjustmentItem[]

  // Inventory movements
  inventoryMovements InventoryMovement[]

  // Cycle counts
  cycleCountItems CycleCountItem[]

  images          String[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@index([brandId])
  @@index([sku])
  @@index([type])
  @@index([status])
}

enum ProductType {
  SIMPLE        // Single item
  VARIANT       // Size/color variants
  BUNDLE        // Multi-pack (e.g., 12-pack Nakd Bars)
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
}

model BundleItem {
  id          String   @id @default(uuid())
  parentId    String
  parent      Product  @relation("ParentBundle", fields: [parentId], references: [id], onDelete: Cascade)
  childId     String
  child       Product  @relation("ChildProduct", fields: [childId], references: [id])
  quantity    Int      // How many child items in bundle

  createdAt   DateTime @default(now())

  @@unique([parentId, childId])
  @@index([parentId])
  @@index([childId])
}

// ===================================
// INVENTORY (With Best-Before Dates)
// ===================================

model Inventory {
  id                String   @id @default(uuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id])
  warehouseId       String
  warehouse         Warehouse @relation(fields: [warehouseId], references: [id])
  locationId        String?
  location          Location? @relation(fields: [locationId], references: [id])

  // Lot/Batch tracking
  lotNumber         String?  // Unique lot identifier
  batchNumber       String?  // Batch identifier
  serialNumber      String?  // For serialized items

  // Best-Before Date (Critical for food)
  bestBeforeDate    DateTime?
  receivedDate      DateTime @default(now())

  // Quantities
  quantity          Int      @default(0)
  availableQuantity Int      @default(0)
  reservedQuantity  Int      @default(0)

  status            InventoryStatus @default(AVAILABLE)

  // Inventory movements
  inventoryMovements InventoryMovement[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([productId, warehouseId, locationId, lotNumber])
  @@index([productId])
  @@index([warehouseId])
  @@index([locationId])
  @@index([bestBeforeDate])
  @@index([lotNumber])
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  QUARANTINE
  DAMAGED
  EXPIRED
}

// ===================================
// STOCK ADJUSTMENTS
// ===================================

model StockAdjustment {
  id            String   @id @default(uuid())
  type          AdjustmentType
  status        AdjustmentStatus @default(PENDING)
  warehouseId   String
  warehouse     Warehouse @relation(fields: [warehouseId], references: [id])
  reason        String
  notes         String?

  requestedBy   String
  user          User     @relation(fields: [requestedBy], references: [id])
  approvedBy    String?
  approver      User?    @relation("ApprovedAdjustments", fields: [approvedBy], references: [id])

  items         StockAdjustmentItem[]

  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([warehouseId])
  @@index([status])
  @@index([createdAt])
}

model StockAdjustmentItem {
  id            String   @id @default(uuid())
  adjustmentId  String
  adjustment    StockAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)

  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  locationId    String?
  location      Location? @relation(fields: [locationId], references: [id])

  batchNumber   String?
  quantity      Int
  unitCost      Float    @default(0)

  createdAt     DateTime @default(now())

  @@index([adjustmentId])
  @@index([productId])
}

enum AdjustmentType {
  INCREASE
  DECREASE
  DAMAGE
  LOSS
  FOUND
  RECOUNT
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
}

// ===================================
// INVENTORY MOVEMENTS
// ===================================

model InventoryMovement {
  id              String   @id @default(uuid())
  type            MovementType

  productId       String
  product         Product  @relation(fields: [productId], references: [id])

  batchId         String?
  batch           Inventory? @relation(fields: [batchId], references: [id])

  fromLocationId  String?
  fromLocation    Location? @relation("MovementsFrom", fields: [fromLocationId], references: [id])

  toLocationId    String?
  toLocation      Location? @relation("MovementsTo", fields: [toLocationId], references: [id])

  quantity        Float
  reason          String?
  notes           String?

  userId          String
  user            User     @relation(fields: [userId], references: [id])

  createdAt       DateTime @default(now())

  @@index([productId])
  @@index([type])
  @@index([userId])
  @@index([createdAt])
}

enum MovementType {
  RECEIVE
  PICK
  TRANSFER
  ADJUST
  RETURN
  CYCLE_COUNT
  SHIPMENT
  DAMAGE
  LOSS
}

// ===================================
// CYCLE COUNTS
// ===================================

model CycleCount {
  id              String   @id @default(uuid())
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  name            String
  status          CycleCountStatus @default(SCHEDULED)
  type            CycleCountType @default(FULL)

  scheduledDate   DateTime
  completedDate   DateTime?

  locations       Json?    // Array of location IDs
  variance        Json?    // { total, positive, negative }

  items           CycleCountItem[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([warehouseId])
  @@index([status])
  @@index([scheduledDate])
}

model CycleCountItem {
  id                String   @id @default(uuid())
  cycleCountId      String
  cycleCount        CycleCount @relation(fields: [cycleCountId], references: [id], onDelete: Cascade)

  productId         String
  product           Product  @relation(fields: [productId], references: [id])

  expectedQuantity  Int      @default(0)
  actualQuantity    Int?
  variance          Int?

  createdAt         DateTime @default(now())

  @@index([cycleCountId])
  @@index([productId])
}

enum CycleCountStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CycleCountType {
  FULL
  PARTIAL
  SPOT
}

// ===================================
// SALES ORDERS (With Wholesale Flag)
// ===================================

model Customer {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  email       String?
  phone       String?
  address     String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  customerType CustomerType @default(B2C)

  orders      SalesOrder[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
}

enum CustomerType {
  B2C         // Business to Consumer
  B2B         // Business to Business (Wholesale)
}

model SalesOrder {
  id              String   @id @default(uuid())
  orderNumber     String   @unique
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])

  // Wholesale flag (critical feature)
  isWholesale     Boolean  @default(false)
  salesChannel    String?  // e.g., "Shopify-B2B", "Shopify-Retail", "Amazon"
  externalOrderId String?  // Original platform order ID

  status          OrderStatus @default(PENDING)
  priority        OrderPriority @default(MEDIUM)

  items           SalesOrderItem[]
  pickLists       PickList[]

  // Financials
  subtotal        Float    @default(0)
  taxAmount       Float    @default(0)
  shippingCost    Float    @default(0)
  discountAmount  Float    @default(0)
  totalAmount     Float    @default(0)

  // Shipping
  shippingAddress String?
  shippingMethod  String?
  trackingNumber  String?

  notes           String?

  orderDate       DateTime @default(now())
  requiredDate    DateTime?
  shippedDate     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderNumber])
  @@index([customerId])
  @@index([status])
  @@index([isWholesale])
  @@index([salesChannel])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  ALLOCATED
  PICKING
  PACKING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SalesOrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  quantity    Int
  unitPrice   Float
  discount    Float    @default(0)
  tax         Float    @default(0)
  totalPrice  Float

  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// ===================================
// PICKING (Smart BB Date Logic)
// ===================================

model PickList {
  id              String   @id @default(uuid())
  pickListNumber  String   @unique
  type            PickListType @default(SINGLE)

  orderId         String?
  order           SalesOrder? @relation(fields: [orderId], references: [id])

  assignedUserId  String?
  assignedUser    User?    @relation(fields: [assignedUserId], references: [id])

  status          PickListStatus @default(PENDING)
  priority        OrderPriority @default(MEDIUM)

  items           PickItem[]

  // Smart wholesale picking
  enforceSingleBBDate Boolean @default(false) // For wholesale bundles

  startedAt       DateTime?
  completedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pickListNumber])
  @@index([orderId])
  @@index([assignedUserId])
  @@index([status])
}

enum PickListType {
  SINGLE      // One order
  BATCH       // Multiple orders
  WAVE        // Time-based wave
  ZONE        // Zone-based picking
}

enum PickListStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model PickItem {
  id              String   @id @default(uuid())
  pickListId      String
  pickList        PickList @relation(fields: [pickListId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])

  // BB date for wholesale
  selectedBBDate  DateTime? // Enforced single BB for wholesale bundles
  lotNumber       String?

  quantityRequired Int
  quantityPicked   Int      @default(0)

  status          PickItemStatus @default(PENDING)
  sequenceNumber  Int      // Pick path optimization

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pickListId])
  @@index([productId])
  @@index([locationId])
}

enum PickItemStatus {
  PENDING
  PICKED
  SHORT_PICKED
  SKIPPED
}

// ===================================
// REPLENISHMENT SYSTEM
// ===================================

model ReplenishmentConfig {
  id              String   @id @default(uuid())
  productId       String   @unique
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Proactive limits
  minStockLevel   Int      // Alert when below this
  maxStockLevel   Int      // Target restock to this
  reorderPoint    Int      // Trigger automatic alert
  reorderQuantity Int      // Suggested order quantity

  // Settings
  autoCreateTasks Boolean  @default(true)
  enabled         Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([productId])
}

model ReplenishmentTask {
  id              String   @id @default(uuid())
  taskNumber      String   @unique
  productId       String
  product         Product  @relation(fields: [productId], references: [id])

  fromLocation    String?  // Source location
  toLocation      String?  // Target location (e.g., pick face)

  quantityNeeded  Int
  quantityMoved   Int      @default(0)

  status          ReplenTaskStatus @default(PENDING)
  priority        OrderPriority @default(MEDIUM)

  assignedUserId  String?

  notes           String?

  createdAt       DateTime @default(now())
  completedAt     DateTime?
  updatedAt       DateTime @updatedAt

  @@index([taskNumber])
  @@index([productId])
  @@index([status])
}

enum ReplenTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ===================================
// FBA TRANSFERS (Two-Stage)
// ===================================

model Transfer {
  id              String   @id @default(uuid())
  transferNumber  String   @unique
  type            TransferType @default(WAREHOUSE)

  fromWarehouseId String
  fromWarehouse   Warehouse @relation("TransferFrom", fields: [fromWarehouseId], references: [id])
  toWarehouseId   String
  toWarehouse     Warehouse @relation("TransferTo", fields: [toWarehouseId], references: [id])

  status          TransferStatus @default(PENDING)

  items           TransferItem[]

  // FBA specific
  fbaShipmentId   String?  // Amazon shipment ID
  fbaDestination  String?  // e.g., "FBA-NYC"

  shipmentBuilt   Boolean  @default(false) // Has shipment builder been used

  notes           String?

  createdAt       DateTime @default(now())
  shippedAt       DateTime?
  receivedAt      DateTime?
  updatedAt       DateTime @updatedAt

  @@index([transferNumber])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([type])
  @@index([status])
}

enum TransferType {
  WAREHOUSE       // Standard warehouse transfer
  FBA_PREP        // Main → Prep warehouse
  FBA_SHIPMENT    // Prep → Amazon FBA
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVING
  COMPLETED
  CANCELLED
}

model TransferItem {
  id              String   @id @default(uuid())
  transferId      String
  transfer        Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  productId       String

  quantity        Int
  receivedQuantity Int     @default(0)

  // FBA bundle creation
  isFBABundle     Boolean  @default(false)
  fbaSku          String?  // FBA-specific SKU

  createdAt       DateTime @default(now())

  @@index([transferId])
  @@index([productId])
}

// ===================================
// SUPPLIERS
// ===================================

model Supplier {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  email       String?
  phone       String?
  address     String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
}

// ===================================
// REVENUE PLANNER / ANALYTICS
// ===================================

model SalesChannel {
  id              String   @id @default(uuid())
  name            String   // e.g., "Amazon FBA", "Shopify Retail"
  code            String   @unique
  type            ChannelType

  // Fee structure
  referralFeePercent    Float?  // e.g., 15% for Amazon
  fixedFee              Float?  // Fixed per-transaction fee
  fulfillmentFeePerUnit Float?  // FBA fulfillment fee
  storageFeePerUnit     Float?  // Monthly storage fee

  // Custom fees (JSON or separate table)
  additionalFees        Json?

  isActive              Boolean @default(true)

  channelPrices         ChannelPrice[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([code])
  @@index([type])
}

enum ChannelType {
  AMAZON_FBA
  SHOPIFY
  EBAY
  DIRECT
  WHOLESALE
  CUSTOM
}

model ChannelPrice {
  id              String   @id @default(uuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  channelId       String
  channel         SalesChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // Pricing
  sellingPrice    Float

  // Cost breakdown
  productCost     Float?   // From product.costPrice
  laborCost       Float?   // Picking, packing labor
  materialCost    Float?   // Packaging materials
  shippingCost    Float?   // Shipping cost

  // Calculated margins
  totalCost       Float?
  grossProfit     Float?
  profitMargin    Float?   // Percentage

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([productId, channelId])
  @@index([productId])
  @@index([channelId])
}
