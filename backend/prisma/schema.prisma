// Kiaan WMS - Comprehensive Database Schema
// Food Distribution Warehouse Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// CORE ENTITIES
// ===================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(USER)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  // Picking assignments
  pickLists PickList[]

  // Stock adjustments
  adjustmentsRequested StockAdjustment[]
  adjustmentsApproved  StockAdjustment[] @relation("ApprovedAdjustments")

  // Inventory movements
  inventoryMovements InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([email])
}

enum Role {
  SUPER_ADMIN
  COMPANY_ADMIN
  WAREHOUSE_MANAGER
  INVENTORY_MANAGER
  PICKER
  VIEWER
  ADMIN
  USER
  PACKER
  MANAGER
}

// Zoltan's Customizations: Location Types
enum LocationType {
  PICK      // Fast-moving pick locations
  BULK      // Bulk storage (pallets)
  BULK_LW   // Bulk storage with 200kg weight limit
}

// Zoltan's Customizations: Marketplace Types
enum MarketplaceType {
  AMAZON_FBA
  AMAZON_MFN
  SHOPIFY
  EBAY
  TIKTOK
  TEMU
  OTHER
}

// Zoltan's Customizations: Consumable Categories
enum ConsumableCategory {
  PACKAGING
  LABEL
  PACKING_MATERIAL
  TAPE
  STATIONERY
  OTHER
}

// Zoltan's Customizations: Sync Status
enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// Zoltan's Customizations: Courier Types
enum CourierType {
  AMAZON_BUY_SHIPPING
  ROYAL_MAIL
  PARCELFORCE
  DPD_UK
  EVRI
  YODEL
  UPS
  FEDEX
  DHL
  OTHER
}

// Zoltan's Customizations: Shipment Status
enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELLED
}

model Company {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  address     String?
  phone       String?
  email       String?

  // Settings fields
  currency    String   @default("USD")
  timezone    String   @default("UTC")
  dateFormat  String   @default("YYYY-MM-DD")
  logo        String?

  // Notification Settings
  emailNotifications    Boolean @default(true)
  lowStockAlerts        Boolean @default(true)
  orderConfirmations    Boolean @default(true)

  // Inventory Settings
  defaultWarehouse      String?
  autoReorderEnabled    Boolean @default(false)
  batchTrackingEnabled  Boolean @default(true)
  expiryTrackingEnabled Boolean @default(true)
  lowStockThreshold     Int     @default(10)
  defaultTaxRate        Float   @default(0)

  users       User[]
  warehouses  Warehouse[]
  products    Product[]
  customers   Customer[]
  suppliers   Supplier[]
  brands      Brand[]
  clients     Client[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
}

// ===================================
// WAREHOUSE STRUCTURE
// ===================================

model Warehouse {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  type        WarehouseType @default(MAIN)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  address     String?
  phone       String?
  capacity    Int?
  status      WarehouseStatus @default(ACTIVE)

  zones       Zone[]
  locations   Location[]
  inventory   Inventory[]
  transfersFrom Transfer[] @relation("TransferFrom")
  transfersTo   Transfer[] @relation("TransferTo")
  adjustments StockAdjustment[]
  cycleCounts CycleCount[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
  @@index([type])
}

enum WarehouseType {
  MAIN        // Main warehouse
  PREP        // FBA preparation warehouse
  RETURNS     // Returns processing
  OVERFLOW    // Overflow storage
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

model Zone {
  id          String   @id @default(uuid())
  name        String
  code        String
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  zoneType    ZoneType @default(STANDARD)

  locations   Location[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([warehouseId, code])
  @@index([warehouseId])
}

enum ZoneType {
  STANDARD
  COLD
  FROZEN
  HAZMAT
  QUARANTINE
}

model Location {
  id          String   @id @default(uuid())
  name        String
  code        String
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  zoneId      String?
  zone        Zone?    @relation(fields: [zoneId], references: [id])
  aisle       String?
  rack        String?
  shelf       String?
  bin         String?

  // Zoltan's Customizations: Location Type & Weight Management
  locationType    LocationType @default(PICK)
  weightLimit     Float?       // Max weight in kg (200kg for BULK_LW)
  currentWeight   Float        @default(0)
  pickSequence    Int?         // Optimal picking order (1, 2, 3...)
  isHeatSensitive Boolean      @default(false) // Temperature controlled location
  isPrimaryPick   Boolean      @default(false) // Primary pick location for a product
  minStockLevel   Int?         // Minimum stock before replenishment
  maxStockLevel   Int?         // Maximum stock capacity

  inventory   Inventory[]
  pickItems   PickItem[]
  adjustmentItems StockAdjustmentItem[]

  // Inventory movements
  movementsFrom InventoryMovement[] @relation("MovementsFrom")
  movementsTo   InventoryMovement[] @relation("MovementsTo")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@index([zoneId])
  @@index([locationType])
  @@index([pickSequence])
  @@index([isPrimaryPick])
}

// ===================================
// PRODUCT MANAGEMENT (Food Focus)
// ===================================

model Brand {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  products    Product[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
}

model Product {
  id              String      @id @default(uuid())
  sku             String      @unique
  name            String
  description     String?
  barcode         String?
  companyId       String
  company         Company     @relation(fields: [companyId], references: [id])
  brandId         String?
  brand           Brand?      @relation(fields: [brandId], references: [id])
  type            ProductType @default(SIMPLE)
  status          ProductStatus @default(ACTIVE)

  // Physical dimensions
  length          Float?
  width           Float?
  height          Float?
  weight          Float?
  dimensionUnit   String?     @default("cm")
  weightUnit      String?     @default("kg")

  // Pricing
  costPrice       Float?
  sellingPrice    Float?
  currency        String      @default("GBP")

  // Zoltan's Customizations: VAT & Heat Sensitivity
  vatRate         Float       @default(20.0)  // UK VAT rate 20%
  vatCode         String?     // VAT category code (e.g., A_FOOD_PLAINBISCUIT)
  isHeatSensitive Boolean     @default(false) // Requires temperature control
  primarySupplierId String?   // Primary supplier for this product
  cartonSizes     Int?        // Units per carton/case

  // Marketplace-specific SKUs (Client requirement from Excel)
  ffdSku          String?     // FFD marketplace SKU
  ffdSaleSku      String?     // FFD sale SKU
  wsSku           String?     // Wholesale SKU
  amzSku          String?     // Amazon standard SKU
  amzSkuBb        String?     // Amazon Best Before rotation SKU
  amzSkuM         String?     // Amazon MFN SKU
  amzSkuEu        String?     // Amazon EU SKU
  onBuySku        String?     // OnBuy marketplace SKU

  // Food-specific
  isPerishable    Boolean     @default(false)
  requiresBatch   Boolean     @default(false)
  requiresSerial  Boolean     @default(false)
  shelfLifeDays   Int?        // Expected shelf life in days

  // Bundle support
  bundleItems     BundleItem[] @relation("ParentBundle")
  partOfBundles   BundleItem[] @relation("ChildProduct")

  // Zoltan's Customizations: Multi-Channel SKU Mapping & Supplier Products
  alternativeSkus AlternativeSku[]
  supplierProducts SupplierProduct[]

  // Inventory
  inventory       Inventory[]
  orderItems      SalesOrderItem[]
  pickItems       PickItem[]

  // Replenishment
  replenConfig    ReplenishmentConfig?
  replenTasks     ReplenishmentTask[]

  // Channel pricing
  channelPrices   ChannelPrice[]

  // Stock adjustments
  adjustmentItems StockAdjustmentItem[]

  // Inventory movements
  inventoryMovements InventoryMovement[]

  // Cycle counts
  cycleCountItems CycleCountItem[]

  // Returns
  returnItems     ReturnItem[]

  // Transfers
  transferItems   TransferItem[] @relation("TransferProducts")

  images          String[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@index([brandId])
  @@index([sku])
  @@index([type])
  @@index([status])
  @@index([isHeatSensitive])
  @@index([primarySupplierId])
}

enum ProductType {
  SIMPLE        // Single item
  VARIANT       // Size/color variants
  BUNDLE        // Multi-pack (e.g., 12-pack Nakd Bars)
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
}

model BundleItem {
  id          String   @id @default(uuid())
  parentId    String
  parent      Product  @relation("ParentBundle", fields: [parentId], references: [id], onDelete: Cascade)
  childId     String
  child       Product  @relation("ChildProduct", fields: [childId], references: [id])
  quantity    Int      // How many child items in bundle

  // Zoltan's Customizations: Auto-Costing from Components
  componentCost Float?  // Auto-calculated: child.costPrice * quantity

  createdAt   DateTime @default(now())

  @@unique([parentId, childId])
  @@index([parentId])
  @@index([childId])
}

// ===================================
// INVENTORY (With Best-Before Dates)
// ===================================

model Inventory {
  id                String   @id @default(uuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id])
  warehouseId       String
  warehouse         Warehouse @relation(fields: [warehouseId], references: [id])
  locationId        String?
  location          Location? @relation(fields: [locationId], references: [id])

  // Lot/Batch tracking
  lotNumber         String?  // Unique lot identifier
  batchNumber       String?  // Batch identifier
  serialNumber      String?  // For serialized items
  batchBarcode      String?  // Barcode for this specific batch/lot

  // Best-Before Date (Critical for food)
  bestBeforeDate    DateTime?
  receivedDate      DateTime @default(now())

  // Quantities
  quantity          Int      @default(0)
  availableQuantity Int      @default(0)
  reservedQuantity  Int      @default(0)

  status            InventoryStatus @default(AVAILABLE)

  // Inventory movements
  inventoryMovements InventoryMovement[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([productId, warehouseId, locationId, lotNumber])
  @@index([productId])
  @@index([warehouseId])
  @@index([locationId])
  @@index([bestBeforeDate])
  @@index([lotNumber])
  @@index([batchBarcode])
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  QUARANTINE
  DAMAGED
  EXPIRED
}

// ===================================
// STOCK ADJUSTMENTS
// ===================================

model StockAdjustment {
  id            String   @id @default(uuid())
  type          AdjustmentType
  status        AdjustmentStatus @default(PENDING)
  warehouseId   String
  warehouse     Warehouse @relation(fields: [warehouseId], references: [id])
  reason        String
  notes         String?

  requestedBy   String
  user          User     @relation(fields: [requestedBy], references: [id])
  approvedBy    String?
  approver      User?    @relation("ApprovedAdjustments", fields: [approvedBy], references: [id])

  items         StockAdjustmentItem[]

  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([warehouseId])
  @@index([status])
  @@index([createdAt])
}

model StockAdjustmentItem {
  id            String   @id @default(uuid())
  adjustmentId  String
  adjustment    StockAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)

  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  locationId    String?
  location      Location? @relation(fields: [locationId], references: [id])

  batchNumber   String?
  quantity      Int
  unitCost      Float    @default(0)

  createdAt     DateTime @default(now())

  @@index([adjustmentId])
  @@index([productId])
}

enum AdjustmentType {
  INCREASE
  DECREASE
  DAMAGE
  LOSS
  FOUND
  RECOUNT
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
}

// ===================================
// INVENTORY MOVEMENTS
// ===================================

model InventoryMovement {
  id              String   @id @default(uuid())
  type            MovementType

  productId       String
  product         Product  @relation(fields: [productId], references: [id])

  batchId         String?
  batch           Inventory? @relation(fields: [batchId], references: [id])

  fromLocationId  String?
  fromLocation    Location? @relation("MovementsFrom", fields: [fromLocationId], references: [id])

  toLocationId    String?
  toLocation      Location? @relation("MovementsTo", fields: [toLocationId], references: [id])

  quantity        Float
  reason          String?
  notes           String?

  userId          String
  user            User     @relation(fields: [userId], references: [id])

  createdAt       DateTime @default(now())

  @@index([productId])
  @@index([type])
  @@index([userId])
  @@index([createdAt])
}

enum MovementType {
  RECEIVE
  PICK
  TRANSFER
  ADJUST
  RETURN
  CYCLE_COUNT
  SHIPMENT
  DAMAGE
  LOSS
}

// ===================================
// CYCLE COUNTS
// ===================================

model CycleCount {
  id              String   @id @default(uuid())
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  name            String
  status          CycleCountStatus @default(SCHEDULED)
  type            CycleCountType @default(FULL)

  scheduledDate   DateTime
  completedDate   DateTime?

  locations       Json?    // Array of location IDs
  variance        Json?    // { total, positive, negative }

  items           CycleCountItem[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([warehouseId])
  @@index([status])
  @@index([scheduledDate])
}

model CycleCountItem {
  id                String   @id @default(uuid())
  cycleCountId      String
  cycleCount        CycleCount @relation(fields: [cycleCountId], references: [id], onDelete: Cascade)

  productId         String
  product           Product  @relation(fields: [productId], references: [id])

  expectedQuantity  Int      @default(0)
  actualQuantity    Int?
  variance          Int?

  createdAt         DateTime @default(now())

  @@index([cycleCountId])
  @@index([productId])
}

enum CycleCountStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CycleCountType {
  FULL
  PARTIAL
  SPOT
}

// ===================================
// SALES ORDERS (With Wholesale Flag)
// ===================================

model Customer {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  email       String?
  phone       String?
  address     String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  customerType CustomerType @default(B2C)

  orders      SalesOrder[]
  returns     Return[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
}

enum CustomerType {
  B2C         // Business to Consumer
  B2B         // Business to Business (Wholesale)
}

model SalesOrder {
  id              String   @id @default(uuid())
  orderNumber     String   @unique
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])

  // Wholesale flag (critical feature)
  isWholesale     Boolean  @default(false)
  salesChannel    String?  // e.g., "Shopify-B2B", "Shopify-Retail", "Amazon"
  externalOrderId String?  // Original platform order ID

  status          OrderStatus @default(PENDING)
  priority        OrderPriority @default(MEDIUM)

  items           SalesOrderItem[]
  pickLists       PickList[]
  returns         Return[]

  // Financials
  subtotal        Float    @default(0)
  taxAmount       Float    @default(0)
  shippingCost    Float    @default(0)
  discountAmount  Float    @default(0)
  totalAmount     Float    @default(0)

  // Shipping
  shippingAddress String?
  shippingMethod  String?
  trackingNumber  String?
  carrier         String?
  shippingNotes   String?

  notes           String?

  orderDate       DateTime @default(now())
  requiredDate    DateTime?
  shippedDate     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderNumber])
  @@index([customerId])
  @@index([status])
  @@index([isWholesale])
  @@index([salesChannel])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  ALLOCATED
  PICKING
  PACKING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SalesOrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  quantity    Int
  unitPrice   Float
  discount    Float    @default(0)
  tax         Float    @default(0)
  totalPrice  Float

  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// ===================================
// PICKING (Smart BB Date Logic)
// ===================================

model PickList {
  id              String   @id @default(uuid())
  pickListNumber  String   @unique
  type            PickListType @default(SINGLE)

  orderId         String?
  order           SalesOrder? @relation(fields: [orderId], references: [id])

  assignedUserId  String?
  assignedUser    User?    @relation(fields: [assignedUserId], references: [id])

  status          PickListStatus @default(PENDING)
  priority        OrderPriority @default(MEDIUM)

  items           PickItem[]

  // Smart wholesale picking
  enforceSingleBBDate Boolean @default(false) // For wholesale bundles

  startedAt       DateTime?
  completedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pickListNumber])
  @@index([orderId])
  @@index([assignedUserId])
  @@index([status])
}

enum PickListType {
  SINGLE      // One order
  BATCH       // Multiple orders
  WAVE        // Time-based wave
  ZONE        // Zone-based picking
}

enum PickListStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model PickItem {
  id              String   @id @default(uuid())
  pickListId      String
  pickList        PickList @relation(fields: [pickListId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])

  // BB date for wholesale
  selectedBBDate  DateTime? // Enforced single BB for wholesale bundles
  lotNumber       String?

  quantityRequired Int
  quantityPicked   Int      @default(0)

  status          PickItemStatus @default(PENDING)
  sequenceNumber  Int      // Pick path optimization

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pickListId])
  @@index([productId])
  @@index([locationId])
}

enum PickItemStatus {
  PENDING
  PICKED
  SHORT_PICKED
  SKIPPED
}

// ===================================
// REPLENISHMENT SYSTEM
// ===================================

model ReplenishmentConfig {
  id              String   @id @default(uuid())
  productId       String   @unique
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Proactive limits
  minStockLevel   Int      // Alert when below this
  maxStockLevel   Int      // Target restock to this
  reorderPoint    Int      // Trigger automatic alert
  reorderQuantity Int      // Suggested order quantity

  // Settings
  autoCreateTasks Boolean  @default(true)
  enabled         Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([productId])
}

model ReplenishmentTask {
  id              String   @id @default(uuid())
  taskNumber      String   @unique
  productId       String
  product         Product  @relation(fields: [productId], references: [id])

  fromLocation    String?  // Source location
  toLocation      String?  // Target location (e.g., pick face)

  quantityNeeded  Int
  quantityMoved   Int      @default(0)

  status          ReplenTaskStatus @default(PENDING)
  priority        OrderPriority @default(MEDIUM)

  assignedUserId  String?

  notes           String?

  createdAt       DateTime @default(now())
  completedAt     DateTime?
  updatedAt       DateTime @updatedAt

  @@index([taskNumber])
  @@index([productId])
  @@index([status])
}

enum ReplenTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ===================================
// FBA TRANSFERS (Two-Stage)
// ===================================

model Transfer {
  id              String   @id @default(uuid())
  transferNumber  String   @unique
  type            TransferType @default(WAREHOUSE)

  fromWarehouseId String
  fromWarehouse   Warehouse @relation("TransferFrom", fields: [fromWarehouseId], references: [id])
  toWarehouseId   String
  toWarehouse     Warehouse @relation("TransferTo", fields: [toWarehouseId], references: [id])

  status          TransferStatus @default(PENDING)

  items           TransferItem[]

  // FBA specific
  fbaShipmentId   String?  // Amazon shipment ID
  fbaDestination  String?  // e.g., "FBA-NYC"

  shipmentBuilt   Boolean  @default(false) // Has shipment builder been used

  notes           String?

  createdAt       DateTime @default(now())
  shippedAt       DateTime?
  receivedAt      DateTime?
  updatedAt       DateTime @updatedAt

  @@index([transferNumber])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([type])
  @@index([status])
}

enum TransferType {
  WAREHOUSE       // Standard warehouse transfer
  FBA_PREP        // Main → Prep warehouse
  FBA_SHIPMENT    // Prep → Amazon FBA
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVING
  COMPLETED
  CANCELLED
}

model TransferItem {
  id              String   @id @default(uuid())
  transferId      String
  transfer        Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation("TransferProducts", fields: [productId], references: [id])

  quantity        Int
  receivedQuantity Int     @default(0)

  // FBA bundle creation
  isFBABundle     Boolean  @default(false)
  fbaSku          String?  // FBA-specific SKU

  createdAt       DateTime @default(now())

  @@index([transferId])
  @@index([productId])
}

// ===================================
// RETURNS / RMA
// ===================================

model Return {
  id              String   @id @default(uuid())
  rmaNumber       String   @unique

  orderId         String?
  order           SalesOrder? @relation(fields: [orderId], references: [id])

  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])

  type            ReturnType @default(RETURN)
  reason          String?
  status          ReturnStatus @default(PENDING)

  items           ReturnItem[]

  totalValue      Float    @default(0)
  refundAmount    Float?

  notes           String?

  requestedAt     DateTime @default(now())
  receivedAt      DateTime?
  processedAt     DateTime?
  completedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([rmaNumber])
  @@index([orderId])
  @@index([customerId])
  @@index([status])
}

model ReturnItem {
  id              String   @id @default(uuid())
  returnId        String
  return          Return   @relation(fields: [returnId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id])

  quantity        Int
  receivedQuantity Int     @default(0)
  condition       String?  // e.g., "Good", "Damaged", "Defective"

  action          ReturnAction @default(PENDING)

  createdAt       DateTime @default(now())

  @@index([returnId])
  @@index([productId])
}

enum ReturnType {
  RETURN
  EXCHANGE
  REFUND
  WARRANTY
}

enum ReturnStatus {
  PENDING
  APPROVED
  RECEIVING
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
}

enum ReturnAction {
  PENDING
  RESTOCK
  DISPOSE
  REPAIR
  EXCHANGE
}

// ===================================
// 3PL CLIENTS (3PL Client Companies)
// ===================================

model Client {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  email       String?
  phone       String?
  address     String?
  contactName String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  status      ClientStatus @default(ACTIVE)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
  @@index([status])
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ===================================
// SUPPLIERS
// ===================================

model Supplier {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  email       String?
  phone       String?
  address     String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  purchaseOrders PurchaseOrder[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([code])
}

// ===================================
// PURCHASE ORDERS
// ===================================

model PurchaseOrder {
  id              String   @id @default(uuid())
  poNumber        String   @unique
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])

  status          PurchaseOrderStatus @default(DRAFT)

  // Items
  items           PurchaseOrderItem[]

  // Goods Receipts
  goodsReceipts   GoodsReceipt[]

  // Financials
  subtotal        Float    @default(0)
  taxAmount       Float    @default(0)
  shippingCost    Float    @default(0)
  totalAmount     Float    @default(0)

  // Dates
  orderDate       DateTime @default(now())
  expectedDelivery DateTime?
  receivedDate    DateTime?

  // Approval
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([supplierId])
  @@index([status])
  @@index([poNumber])
  @@index([orderDate])
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model PurchaseOrderItem {
  id              String   @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  productId       String
  productName     String      // Denormalized for quick access
  productSku      String      // Denormalized for quick access

  quantity        Int
  receivedQty     Int         @default(0)
  unitPrice       Float
  totalPrice      Float

  // For bundles
  isBundle        Boolean     @default(false)
  bundleQty       Int?        // Quantity per bundle if it's a bundle

  notes           String?

  // Goods receipt items
  goodsReceiptItems GoodsReceiptItem[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([purchaseOrderId])
  @@index([productId])
}

// ===================================
// GOODS RECEIVING
// ===================================

model GoodsReceipt {
  id              String   @id @default(uuid())
  grNumber        String   @unique

  // Link to Purchase Order
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  status          GoodsReceiptStatus @default(PENDING)

  // Items received
  items           GoodsReceiptItem[]

  // Receiving details
  receivedBy      String?
  receivedDate    DateTime?

  // Quality check
  qualityStatus   String?     // PASSED, FAILED, PARTIAL
  qualityNotes    String?

  // Totals
  totalExpected   Int         @default(0)
  totalReceived   Int         @default(0)
  totalDamaged    Int         @default(0)

  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([purchaseOrderId])
  @@index([grNumber])
  @@index([status])
  @@index([receivedDate])
}

enum GoodsReceiptStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model GoodsReceiptItem {
  id                  String   @id @default(uuid())
  goodsReceiptId      String
  goodsReceipt        GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)

  // Link to PO Item
  purchaseOrderItemId String
  purchaseOrderItem   PurchaseOrderItem @relation(fields: [purchaseOrderItemId], references: [id])

  // Product info (denormalized)
  productId           String
  productName         String
  productSku          String

  // Quantities
  expectedQty         Int
  receivedQty         Int         @default(0)
  damagedQty          Int         @default(0)

  // Batch/Lot tracking
  batchNumber         String?
  lotNumber           String?
  bestBeforeDate      DateTime?

  // Location where items are put away
  locationId          String?

  // Quality
  qualityStatus       String?     // GOOD, DAMAGED, REJECTED
  qualityNotes        String?

  notes               String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([goodsReceiptId])
  @@index([purchaseOrderItemId])
  @@index([productId])
}

// ===================================
// REVENUE PLANNER / ANALYTICS
// ===================================

model SalesChannel {
  id              String   @id @default(uuid())
  name            String   // e.g., "Amazon FBA", "Shopify Retail"
  code            String   @unique
  type            ChannelType

  // API Integration
  apiKey          String?  // API key for marketplace integration
  apiSecret       String?  // API secret
  webhookUrl      String?  // Webhook URL for events
  syncFrequency   Int?     @default(5) // Sync frequency in minutes

  // Fee structure
  referralFeePercent    Float?  // e.g., 15% for Amazon
  fixedFee              Float?  // Fixed per-transaction fee
  fulfillmentFeePerUnit Float?  // FBA fulfillment fee
  storageFeePerUnit     Float?  // Monthly storage fee

  // Custom fees (JSON or separate table)
  additionalFees        Json?

  isActive              Boolean @default(true)
  lastSyncAt            DateTime? // Last successful sync

  channelPrices         ChannelPrice[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([code])
  @@index([type])
}

enum ChannelType {
  AMAZON_FBA
  SHOPIFY
  EBAY
  DIRECT
  WHOLESALE
  CUSTOM
}

model ChannelPrice {
  id              String   @id @default(uuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  channelId       String
  channel         SalesChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // Pricing
  sellingPrice    Float

  // Zoltan's Customizations: VAT Calculations
  vatRate         Float?   // VAT rate for this channel (defaults to product.vatRate)
  priceExVat      Float?   // Price excluding VAT
  vatAmount       Float?   // VAT amount
  priceIncVat     Float?   // Total price including VAT

  // Cost breakdown
  productCost     Float?   // From product.costPrice
  laborCost       Float?   // Picking, packing labor
  materialCost    Float?   // Packaging materials
  shippingCost    Float?   // Shipping cost

  // Calculated margins
  totalCost       Float?
  grossProfit     Float?
  profitMargin    Float?   // Percentage

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([productId, channelId])
  @@index([productId])
  @@index([channelId])
}

// ===================================
// ZOLTAN'S CUSTOMIZATIONS
// ===================================

// Alternative SKU Mapping for Multi-Channel Sales
model AlternativeSku {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  channel     MarketplaceType
  sku         String   // Alternative SKU for this channel
  skuSuffix   String?  // "_BB" for rotation, "_M" for MFN
  fnsku       String?  // Amazon FNSKU
  asin        String?  // Amazon ASIN
  isActive    Boolean  @default(true)
  companyId   String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([productId, channel, sku])
  @@index([productId])
  @@index([channel])
  @@index([sku])
  @@index([fnsku])
  @@index([asin])
  @@index([companyId])
}

// Supplier Product Database with Case Sizes
model SupplierProduct {
  id              String   @id @default(uuid())
  supplierId      String
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierSku     String   // Supplier's SKU
  supplierName    String?  // Product name at supplier
  caseSize        Int      // Units per case
  caseCost        Float?   // Cost per case
  unitCost        Float?   // Auto-calculated: caseCost / caseSize
  isPrimary       Boolean  @default(false)
  leadTimeDays    Int?     // Lead time in days
  moq             Int?     // Minimum order quantity
  companyId       String

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([supplierId, supplierSku])
  @@index([productId])
  @@index([supplierId])
  @@index([isPrimary])
  @@index([companyId])
}

// Consumables Module for Packaging Materials
model Consumable {
  id              String   @id @default(uuid())
  sku             String   @unique
  name            String
  category        ConsumableCategory @default(PACKAGING)
  currentStock    Int      @default(0)
  minStockLevel   Int      @default(10)
  unitCost        Float
  companyId       String

  // Usage tracking
  usage           ConsumableUsage[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sku])
  @@index([category])
  @@index([companyId])
}

model ConsumableUsage {
  id              String   @id @default(uuid())
  consumableId    String
  consumable      Consumable @relation(fields: [consumableId], references: [id])
  quantity        Int
  usedBy          String?  // User ID or process
  orderId         String?  // Link to order if used for order fulfillment
  reason          String?  // Usage reason
  companyId       String

  createdAt       DateTime @default(now())

  @@index([consumableId])
  @@index([orderId])
  @@index([createdAt])
  @@index([companyId])
}

// Marketplace Integrations
model MarketplaceConnection {
  id              String   @id @default(uuid())
  companyId       String
  marketplace     MarketplaceType
  accountName     String

  // Generic API credentials
  apiKey          String?
  apiSecret       String?
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?

  // Amazon SP-API specific fields
  sellerId        String?       // Amazon Merchant Token
  clientId        String?       // Amazon SP-API Client ID
  clientSecret    String?       // Amazon SP-API Client Secret
  awsAccessKeyId  String?       // AWS access key for Amazon SP-API
  awsSecretKey    String?       // AWS secret key for Amazon SP-API
  region          String?       // AWS region (eu-west-1 for UK)

  // Shopify specific fields
  shopUrl         String?       // Shopify store URL (e.g., free-from-direct.myshopify.com)
  shopifyApiKey   String?       // Shopify API Key
  shopifyApiSecret String?      // Shopify API Secret
  shopifyAccessToken String?    // Shopify Admin API access token

  // eBay specific fields
  ebayAppId       String?       // eBay App ID (Client ID)
  ebayDevId       String?       // eBay Dev ID
  ebayCertId      String?       // eBay Cert ID (Client Secret)
  ebayAuthToken   String?       // eBay OAuth token
  ebayRefreshToken String?      // eBay refresh token
  ebayEnvironment String?       // 'sandbox' or 'production'

  // Generic store ID for other platforms
  storeId         String?       // For TikTok, Temu, etc.

  // Sync settings
  autoSyncOrders  Boolean  @default(true)
  autoSyncStock   Boolean  @default(true)
  syncFrequency   Int?     @default(30) // Minutes between syncs
  lastSyncAt      DateTime?
  lastSyncError   String?
  isActive        Boolean  @default(true)

  // Sync logs
  orderSyncs      MarketplaceOrderSync[]
  stockSyncs      MarketplaceStockSync[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([companyId, marketplace, accountName])
  @@index([companyId])
  @@index([marketplace])
  @@index([isActive])
}

model MarketplaceOrderSync {
  id              String   @id @default(uuid())
  connectionId    String
  connection      MarketplaceConnection @relation(fields: [connectionId], references: [id])
  orderId         String?  // WMS order ID created
  externalOrderId String   // Order ID from marketplace
  status          SyncStatus @default(PENDING)
  errorMessage    String?
  orderData       Json?    // Full order data from marketplace

  syncedAt        DateTime @default(now())

  @@unique([connectionId, externalOrderId])
  @@index([connectionId])
  @@index([status])
  @@index([syncedAt])
}

model MarketplaceStockSync {
  id              String   @id @default(uuid())
  connectionId    String
  connection      MarketplaceConnection @relation(fields: [connectionId], references: [id])
  productId       String
  sku             String
  quantitySynced  Int
  status          SyncStatus @default(COMPLETED)
  errorMessage    String?

  syncedAt        DateTime @default(now())

  @@index([connectionId])
  @@index([productId])
  @@index([status])
  @@index([syncedAt])
}

// UK Courier Integrations
model CourierConnection {
  id              String   @id @default(uuid())
  companyId       String
  courier         CourierType
  accountName     String

  // Generic API credentials
  apiKey          String?           // Main API key/authorization key
  apiSecret       String?           // API secret if required
  accountNumber   String?           // Courier account number
  username        String?           // Account username
  password        String?           // Account password (encrypted)

  // Royal Mail / Parcelforce specific
  royalMailApiKey       String?     // Royal Mail Click & Drop API key
  royalMailPostingLocation String?  // Posting location ID
  parcelforceContractNumber String? // Parcelforce contract number

  // DPD specific
  dpdGeoSession   String?           // DPD GeoSession token
  dpdAccountCode  String?           // DPD account code

  // Generic OAuth fields for carriers that use OAuth
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?

  // Settings
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  testMode        Boolean  @default(false) // Use sandbox/test environment

  // Service options
  defaultService  String?           // Default service code
  serviceOptions  Json?             // Available services for this carrier

  // Shipments
  shipments       CourierShipment[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([companyId, courier, accountName])
  @@index([companyId])
  @@index([courier])
  @@index([isActive])
  @@index([isDefault])
}

model CourierShipment {
  id              String   @id @default(uuid())
  connectionId    String
  connection      CourierConnection @relation(fields: [connectionId], references: [id])
  orderId         String?  // Link to WMS order
  trackingNumber  String
  labelUrl        String?  // URL to shipping label PDF
  serviceCode     String?  // e.g., 'ROYAL_MAIL_24', 'DPD_NEXT_DAY'
  weight          Float?   // Package weight
  cost            Float?   // Shipping cost
  status          ShipmentStatus @default(PENDING)
  estimatedDelivery DateTime?
  actualDelivery  DateTime?
  companyId       String

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([trackingNumber])
  @@index([connectionId])
  @@index([orderId])
  @@index([status])
  @@index([trackingNumber])
  @@index([companyId])
}
